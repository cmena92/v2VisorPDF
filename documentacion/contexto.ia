# CONTEXTO T√âCNICO Y FUNCIONAL - VISOR PDF CRISMAN

## INFORMACI√ìN GENERAL DEL PROYECTO

**Nombre del Sistema:** Visor PDF Crisman  
**Tipo de Proyecto:** Plugin WordPress  
**Versi√≥n:** 2.0.0  
**Autor:** Crisman  
**Fecha de Desarrollo:** Diciembre 2024 - Julio 2025  
**Estado:** FASE 5B COMPLETADA - Dashboard de Analytics Funcional  

## RESUMEN EJECUTIVO

Sistema desarrollado para gestionar, visualizar y controlar acceso a documentos PDF (espec√≠ficamente actas) con alta seguridad, marcas de agua personalizadas y sistema completo de auditor√≠a. El sistema impide la descarga directa de documentos y registra todas las actividades de visualizaci√≥n.

**√öLTIMO ESTADO:** Completado dashboard visual de analytics con estad√≠sticas en tiempo real, m√©tricas generales, rankings, distribuci√≥n por dispositivos y widget integrado en WordPress.

## ARQUITECTURA DEL SISTEMA

### Estructura de Archivos
```
visor_pdf_crisman/
‚îú‚îÄ‚îÄ visor-pdf-crisman.php          # Archivo principal del plugin
‚îú‚îÄ‚îÄ README.md                      # Documentaci√≥n de usuario
‚îú‚îÄ‚îÄ documentacion/
‚îÇ   ‚îî‚îÄ‚îÄ contexto.ia               # Este archivo de contexto
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ visor-pdf.js              # JavaScript del visor (funcionalidad frontend)
‚îÇ   ‚îî‚îÄ‚îÄ visor-pdf.css             # Estilos CSS (interfaz y responsividad)
‚îú‚îÄ‚îÄ includes/
‚îÇ   ‚îú‚îÄ‚îÄ install-utils.php         # Utilidades de instalaci√≥n y verificaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ security-config.php       # Configuraciones avanzadas de seguridad
‚îî‚îÄ‚îÄ templates/
    ‚îú‚îÄ‚îÄ admin-list.php            # Interfaz de administraci√≥n - lista de actas
    ‚îú‚îÄ‚îÄ admin-upload.php          # Interfaz de administraci√≥n - subida de archivos
    ‚îú‚îÄ‚îÄ admin-logs.php            # Interfaz de administraci√≥n - logs de auditor√≠a
    ‚îî‚îÄ‚îÄ viewer.php                # Visor frontend para usuarios finales
```

### Tecnolog√≠as Utilizadas
- **Backend:** PHP 7.4+, WordPress 5.0+
- **Frontend:** JavaScript (ES6+), jQuery, CSS3
- **Base de Datos:** MySQL 5.7+ (usando $wpdb de WordPress)
- **Procesamiento PDF:** Imagick PHP Extension
- **Seguridad:** Headers HTTP, protecciones CSS/JS, ofuscaci√≥n
- **UI/UX:** CSS Grid, Flexbox, Modal responsivo

## FUNCIONALIDADES PRINCIPALES

### 1. GESTI√ìN DE DOCUMENTOS
- **Subida de PDFs:** Solo administradores pueden subir archivos PDF
- **Metadatos:** T√≠tulo, descripci√≥n, fecha de subida, usuario que subi√≥
- **Validaci√≥n:** Solo acepta archivos PDF, l√≠mites de tama√±o configurables
- **Almacenamiento Seguro:** Archivos guardados en carpeta protegida con .htaccess
- **Nomenclatura √önica:** Nombres de archivo con uniqid() para evitar conflictos

### 2. VISUALIZACI√ìN SEGURA
- **Conversi√≥n a Im√°genes:** PDFs convertidos a PNG usando Imagick
- **P√°gina por P√°gina:** Carga individual de cada p√°gina
- **Marcas de Agua:** N√∫mero de colegiado + timestamp en cada p√°gina
- **Sin Descarga Directa:** URLs no accesibles, im√°genes temporales
- **Controles de Navegaci√≥n:** Anterior/Siguiente, ir a p√°gina espec√≠fica
- **Controles de Zoom:** 50% a 300%, bot√≥n ajustar autom√°tico

### 3. SISTEMA DE SEGURIDAD
- **Autenticaci√≥n:** Solo usuarios logueados
- **Autorizaci√≥n:** Verificaci√≥n de n√∫mero de colegiado
- **Protecciones Frontend:**
  - Bloqueo de herramientas de desarrollador (F12, DevTools)
  - Deshabilitaci√≥n de clic derecho, selecci√≥n de texto, drag & drop
  - Protecci√≥n contra print screen y capturas
  - Detecci√≥n de cambio de ventana/pesta√±a
  - Ofuscaci√≥n de console.log
- **Protecciones Backend:**
  - Headers de seguridad HTTP
  - Archivos .htaccess para denegar acceso directo
  - Validaci√≥n de nonces en todas las peticiones AJAX

### 4. AUDITOR√çA Y LOGS
- **Registro de Visualizaciones:** Cada p√°gina vista se registra con:
  - Usuario y n√∫mero de colegiado
  - Archivo y p√°gina visualizada
  - Timestamp, IP, User Agent
- **Actividades Sospechosas:** Registro de:
  - Intentos de uso de DevTools
  - Cambios de ventana durante visualizaci√≥n
  - Intentos de print screen
  - Sesiones concurrentes
- **Dashboard de Estad√≠sticas:** Total visualizaciones, usuarios √∫nicos, actas m√°s vistas

## CONFIGURACI√ìN T√âCNICA

### Requisitos del Sistema
- **WordPress:** 5.0 o superior
- **PHP:** 7.4 o superior con extensi√≥n Imagick
- **MySQL:** 5.7 o superior
- **Memoria PHP:** M√≠nimo 256MB (recomendado 512MB)
- **Permisos:** Escritura en wp-content/uploads/

### Tablas de Base de Datos
1. **wp_actas_metadata:** Metadatos de las actas
2. **wp_actas_logs:** Logs de visualizaci√≥n
3. **wp_actas_suspicious_logs:** Registros de actividades sospechosas

### Configuraci√≥n de Imagick
- **Resoluci√≥n:** 200 DPI para calidad √≥ptima
- **Formato de Salida:** PNG para compatibilidad
- **Procesamiento:** P√°gina por p√°gina bajo demanda
- **Marca de Agua:** M√∫ltiples capas con n√∫mero de colegiado

## FLUJO DE TRABAJO DEL SISTEMA

### Proceso de Subida de Actas
1. Administrador accede a "Visor PDF ‚Üí Subir Actas"
2. Completa formulario (t√≠tulo, descripci√≥n, archivo PDF)
3. Sistema valida archivo (tipo, tama√±o)
4. Genera nombre √∫nico y mueve archivo a carpeta protegida
5. Extrae n√∫mero de p√°ginas usando Imagick
6. Guarda metadatos en base de datos
7. Confirma subida exitosa

### Proceso de Visualizaci√≥n
1. Usuario logueado visita p√°gina con shortcode `[actas_viewer]`
2. Sistema verifica autenticaci√≥n y n√∫mero de colegiado
3. Muestra lista de actas disponibles
4. Usuario hace clic en "Ver Acta"
5. Se abre modal con visor PDF
6. JavaScript solicita p√°gina v√≠a AJAX
7. PHP procesa PDF con Imagick, agrega marcas de agua
8. Retorna imagen PNG temporal
9. JavaScript muestra imagen y registra visualizaci√≥n
10. Sistema limpia recursos temporales

### Proceso de Navegaci√≥n
1. Usuario usa controles de navegaci√≥n (anterior/siguiente/ir a p√°gina)
2. JavaScript valida l√≠mites de p√°ginas
3. Solicita nueva p√°gina v√≠a AJAX
4. Repite proceso de generaci√≥n de imagen con marcas de agua
5. Actualiza vista y registra nueva visualizaci√≥n

## MEDIDAS DE SEGURIDAD IMPLEMENTADAS

### Nivel de Archivo
- **Carpeta Protegida:** .htaccess que niega acceso directo
- **Nombres √önicos:** uniqid() + sanitizaci√≥n para evitar conflictos
- **Validaci√≥n de Tipos:** Solo acepta application/pdf

### Nivel de Aplicaci√≥n
- **Nonces:** Validaci√≥n en todas las peticiones AJAX
- **Sanitizaci√≥n:** Todos los inputs sanitizados
- **Verificaci√≥n de Permisos:** Checks de usuario en cada acci√≥n
- **Rate Limiting:** Prevenci√≥n de abuso mediante logs

### Nivel de Interfaz
- **CSS Protections:** Deshabilitaci√≥n de selecci√≥n, drag & drop
- **JavaScript Hooks:** Detecci√≥n y bloqueo de herramientas de desarrollador
- **Event Blocking:** Prevenci√≥n de atajos de teclado peligrosos
- **URL Ofuscation:** URLs de im√°genes temporales que se auto-destruyen

### Nivel de Red
- **Headers HTTP:** X-Frame-Options, X-Content-Type-Options, etc.
- **Referrer Policy:** Control de informaci√≥n de referencia
- **HTTPS Ready:** Compatible con conexiones seguras

## PERSONALIZACI√ìN Y EXTENSIBILIDAD

### Hooks Disponibles
```php
// Antes de mostrar una acta
do_action('actas_before_display', $acta_id, $user_id);

// Despu√©s de cargar una p√°gina
do_action('actas_page_loaded', $acta_id, $page_num, $user_id);

// Al detectar actividad sospechosa
do_action('actas_suspicious_activity', $activity_type, $user_id);
```

### Filtros Disponibles
```php
// Modificar configuraci√≥n de Imagick
$config = apply_filters('actas_imagick_config', $default_config);

// Personalizar texto de marca de agua
$watermark_text = apply_filters('actas_watermark_text', $default_text, $numero_colegiado);
```

### Shortcode
```php
[actas_viewer]                    // B√°sico
[actas_viewer limite="5"]         // Limitar resultados
[actas_viewer categoria="tipo"]   // Filtrar por categor√≠a (funcionalidad futura)
```

## RESOLUCI√ìN DE PROBLEMAS COMUNES

### Error: Imagick no disponible
- Instalar php-imagick en el servidor
- Verificar que soporte PDF: `$imagick->queryFormats('PDF')`
- Reiniciar servidor web despu√©s de instalaci√≥n

### Error: Permisos de archivo
- Verificar permisos de wp-content/uploads/
- Configurar propietario correcto (www-data en Linux)
- Asegurar que .htaccess se cree correctamente

### Error: Memoria insuficiente
- Aumentar memory_limit en php.ini (m√≠nimo 512M)
- Ajustar max_execution_time para PDFs grandes
- Optimizar resoluci√≥n de Imagick si es necesario

### Error: Scroll no funciona
- Verificar que pointer-events: auto est√© en .pdf-page-display
- Revisar que overflow: auto est√© configurado
- Confirmar que protecciones CSS no bloqueen eventos

## M√âTRICAS Y MONITOREO

### Dashboard de Administraci√≥n
- **Total Visualizaciones:** Contador global de p√°ginas vistas
- **Usuarios √önicos:** N√∫mero de usuarios diferentes que han accedido
- **Actas M√°s Vistas:** Ranking de documentos m√°s consultados
- **Actividades Sospechosas:** Alertas de comportamientos an√≥malos

### Logs Detallados
- **Visualizaciones:** Usuario, documento, p√°gina, timestamp, IP, navegador
- **Actividades Sospechosas:** Tipo de actividad, contexto, frecuencia
- **Rendimiento:** Tiempos de carga, errores de procesamiento

## OPTIMIZACIONES DE RENDIMIENTO

### Frontend
- **Lazy Loading:** P√°ginas se cargan bajo demanda
- **Memory Management:** URLs de blob se limpian autom√°ticamente
- **Zoom Inteligente:** Transform CSS en lugar de re-renderizado
- **Cach√© de Im√°genes:** Reutilizaci√≥n temporal durante navegaci√≥n

### Backend
- **Procesamiento Eficiente:** Imagick optimizado para resoluci√≥n adecuada
- **Limpieza Autom√°tica:** Archivos temporales se eliminan despu√©s de uso
- **Base de Datos Optimizada:** √çndices en columnas de b√∫squeda frecuente
- **Consultas Eficientes:** Prepared statements y l√≠mites apropiados

## FUTURAS MEJORAS SUGERIDAS

### Funcionalidades
- **Sistema de Categor√≠as:** Organizaci√≥n tem√°tica de actas
- **B√∫squeda de Contenido:** OCR para buscar texto dentro de PDFs
- **Comentarios y Anotaciones:** Sistema colaborativo de notas
- **Notificaciones:** Alertas de nuevas actas disponibles
- **API REST:** Exposici√≥n de datos para integraciones externas

### Seguridad
- **2FA:** Autenticaci√≥n de dos factores para usuarios sensibles
- **Watermark Din√°mico:** Marcas de agua que cambien con el tiempo
- **Geolocalizaci√≥n:** Restricciones basadas en ubicaci√≥n
- **Session Management:** Control m√°s granular de sesiones

### Experiencia de Usuario
- **Vista Previa:** Thumbnails de p√°ginas para navegaci√≥n r√°pida
- **Modo Presentaci√≥n:** Vista de pantalla completa
- **Favoritos:** Sistema de marcado de actas importantes
- **Historial de Lectura:** Seguimiento de progreso por documento

## CONSIDERACIONES DE DESPLIEGUE

### Ambiente de Producci√≥n
- **HTTPS Obligatorio:** Para proteger transmisi√≥n de datos
- **Backup Regular:** Especialmente de la carpeta de actas y base de datos
- **Monitoreo de Recursos:** CPU y memoria durante procesamiento de PDFs
- **Logs de Seguridad:** Integraci√≥n con sistemas de monitoreo existentes

### Escalabilidad
- **CDN:** Para servir assets est√°ticos del plugin
- **Cache de Objetos:** Para consultas de base de datos frecuentes
- **Queue System:** Para procesamiento as√≠ncrono de PDFs grandes
- **Load Balancing:** Consideraciones para m√∫ltiples servidores

## ARQUITECTURA DE C√ìDIGO

### Patr√≥n de Dise√±o
- **Singleton Pattern:** Clase principal del plugin
- **Factory Pattern:** Generaci√≥n de im√°genes con marcas de agua
- **Observer Pattern:** Sistema de hooks y filtros de WordPress
- **Strategy Pattern:** Diferentes m√©todos de autenticaci√≥n/autorizaci√≥n

### Principios SOLID Aplicados
- **Single Responsibility:** Cada clase/funci√≥n tiene una responsabilidad espec√≠fica
- **Open/Closed:** Extensible v√≠a hooks sin modificar c√≥digo core
- **Liskov Substitution:** Interfaces consistentes para diferentes componentes
- **Interface Segregation:** Separaci√≥n clara entre frontend y backend
- **Dependency Inversion:** Dependencias inyectadas v√≠a WordPress APIs

## TESTING Y CALIDAD

### Pruebas Realizadas
- **Funcionalidad Core:** Subida, visualizaci√≥n, navegaci√≥n, zoom
- **Seguridad:** Intentos de acceso directo, bypass de controles
- **Compatibilidad:** Diferentes navegadores y dispositivos
- **Rendimiento:** PDFs de diferentes tama√±os y n√∫mero de p√°ginas
- **Edge Cases:** Usuarios sin n√∫mero de colegiado, archivos corruptos

### Calidad de C√≥digo
- **Est√°ndares WordPress:** Seguimiento de WordPress Coding Standards
- **Documentaci√≥n:** Comentarios inline y documentaci√≥n de funciones
- **Sanitizaci√≥n:** Todos los inputs sanitizados apropiadamente
- **Validaci√≥n:** Verificaci√≥n de datos en frontend y backend
- **Error Handling:** Manejo graceful de errores y excepciones

## MANTENIMIENTO Y SOPORTE

### Rutinas de Mantenimiento
- **Limpieza de Logs:** Rotaci√≥n autom√°tica de logs antiguos
- **Optimizaci√≥n DB:** Limpieza de metadatos hu√©rfanos
- **Actualizaci√≥n de Dependencias:** Verificaci√≥n peri√≥dica de Imagick
- **Backup de Configuraci√≥n:** Respaldo de settings cr√≠ticos

### Documentaci√≥n para Desarrolladores
- **C√≥digo Comentado:** Explicaciones inline de l√≥gica compleja
- **README T√©cnico:** Instrucciones de instalaci√≥n y configuraci√≥n
- **Changelog:** Registro de cambios y versiones
- **API Documentation:** Descripci√≥n de hooks, filtros y funciones p√∫blicas

---

## HISTORIAL DE DESARROLLO COMPLETADO

### ‚úÖ FASE 1: MVP BASE (Completada)
- Sistema base de visualizaci√≥n segura
- Subida individual de PDFs
- Marcas de agua din√°micas
- Sistema de logs y auditor√≠a
- Protecciones de seguridad frontend/backend

### ‚úÖ FASE 2: SISTEMA DE CARPETAS (Completada)
- Gesti√≥n jer√°rquica de carpetas
- CRUD completo con AJAX
- Migraci√≥n autom√°tica de datos
- Reasignaci√≥n masiva de actas
- Interfaz administrativa avanzada

### ‚úÖ FASE 3: SUBIDA MASIVA (Completada)
- Interfaz drag & drop moderna
- Procesamiento hasta 20 PDFs simult√°neos
- Sistema de progreso en tiempo real
- Validaciones robustas frontend/backend
- Integraci√≥n completa con sistema de carpetas

### ‚úÖ FASE 4: NAVEGACI√ìN FRONTEND (Completada - Julio 2025)
- Explorador de carpetas intuitivo para usuarios finales
- Sistema de breadcrumb din√°mico y clickeable
- B√∫squeda global inteligente en tiempo real
- Filtros avanzados combinables (fecha, p√°ginas, orden)
- Shortcode extendido [actas_navigator] con par√°metros
- Experiencia responsive y accesible completa

### ‚úÖ FASE 5A: BASE DE ANALYTICS (Completada - Julio 2025)
- Infraestructura base para analytics avanzados
- Tracking extendido con dispositivo, navegador, sesi√≥n
- Sistema de cache inteligente con transients
- Estad√≠sticas generales y en tiempo real
- Endpoints AJAX para datos de analytics
- Nuevas columnas optimizadas en base de datos

### ‚úÖ FASE 5B: DASHBOARD B√ÅSICO (Completada - Julio 2025)
- Dashboard visual completo con estad√≠sticas en tiempo real
- Interfaz moderna responsive con cards y gr√°ficos CSS
- Rankings de actas m√°s vistas y usuarios m√°s activos
- Distribuci√≥n por dispositivos con gr√°fico de barras
- Widget integrado en dashboard principal de WordPress
- Botones de acci√≥n y auto-refresh cada 5 minutos

### üîÑ REFACTORIZACI√ìN MODULAR (Completada)
- Arquitectura modular con clases separadas
- JavaScript organizado en m√≥dulos ES6
- Separaci√≥n clara de responsabilidades
- Optimizaci√≥n de carga de recursos
- Preparaci√≥n para escalabilidad futura

---

**NOTA IMPORTANTE PARA IAs/LLMs:****

Este contexto representa un sistema completamente funcional y probado. Al trabajar con este c√≥digo:

1. **Respetar la Arquitectura:** El sistema tiene una estructura espec√≠fica que funciona
2. **Mantener Seguridad:** Las protecciones implementadas son cr√≠ticas y no deben removerse
3. **Considerar Dependencias:** Imagick es requerido, verificar antes de hacer cambios
4. **Entender el Flujo:** El proceso de conversi√≥n PDF‚ÜíPNG‚ÜíMarcas de agua es el core del sistema
5. **Preservar Logs:** El sistema de auditor√≠a es fundamental para el negocio
6. **Responsive:** El dise√±o debe mantenerse funcional en todos los dispositivos

El sistema est√° optimizado para equilibrar seguridad m√°xima con experiencia de usuario fluida y capacidades de navegaci√≥n avanzada. Cualquier modificaci√≥n debe considerar estos aspectos fundamentales.

---

**Fecha de √öltima Actualizaci√≥n:** 11 de Julio, 2025  
**Pr√≥xima Fase Planificada:** Fase 5 - Analytics Avanzados  
**Estado del Proyecto:** ‚úÖ PRODUCCI√ìN - COMPLETAMENTE FUNCIONAL CON NAVEGACI√ìN FRONTEND
